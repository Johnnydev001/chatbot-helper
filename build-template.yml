parameters:
  type: frontend
  workingDir: frontend
  buildOutputPath: build
  dockerImageName: chatbot-helper-frontend

steps:
  - script: echo "Building ${{ parameters.type }} project"
    displayName: Building ${{ parameters.type }} project

  - task: UseNode@1
    displayName: Install NodeJS
    inputs:
      version: 18.17.0

  - task: Npm@1
    displayName: Install dependencies
    inputs:
      command: custom
      customCommand: install -D vite
      workingDir:  ${{ parameters.workingDir }}

  - task: Npm@1
    inputs:
      command: custom
      customCommand: run lint
      workingDir: ${{ parameters.workingDir }}
    displayName: Run lint

  - task: Npm@1
    displayName: Run build
    inputs:
      command: custom
      customCommand: run build
      workingDir: ${{ parameters.workingDir }}

  - task: Docker@2
    displayName: Docker login
    command: login
    inputs:
      containerRegistry: 'DockerHub'
      repository: ${{parameters.dockerImageName}}
      username: ${{parameters.dockerUsername}}
      password: ${{parameters.dockerPassword}}

  - script: docker login -u johnnymacarroni95 -p Fl1337State
    displayName: Docker login
    workingDirectory: ${{ parameters.workingDir }}

  - script: docker build -t ${{parameters.dockerImageName}} ${{ parameters.workingDir }}
    displayName: Build docker image
    workingDirectory: ${{ parameters.workingDir }}

  - script: docker push ${{parameters.dockerImageName}}
    displayName: Push docker image
    workingDirectory: ${{ parameters.workingDir }}

  - task: CopyFiles@2
    displayName: Copy build output to artifact directory
    inputs:
      SourceFolder: ${{ parameters.workingDir }}/dist
      Contents: '**'
      TargetFolder: $(Build.ArtifactStagingDirectory)/${{parameters.buildOutputPath}}

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)/${{parameters.buildOutputPath}}
      ArtifactName: frontend-build-artifact
    displayName: Publish build artifacts